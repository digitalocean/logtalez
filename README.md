logtalez
========

logtalez, oo-ooo

# What Is This?
## Overview
logtalez is a minimal command line client (and API) for retrieving log streams from the
rsyslog logging daemon over zeromq. 

An rsyslog config emits logs over a zeromq publish socket, dynamically
constructing topics from the host and program name that generated the log.

The command line client can be used to subscribe to host / program name 
combinations and the logs are fed to stdout, where you can interact with 
them using whatever tools you wish.

Access to the zeromq socket is controlled via encryption certs, and all 
traffic between the server and client is encrypted.

# How Do I Build and Use This?
## Dependencies
### [libsodium](https://github.com/jedisct1/libsodium)
Version: 1.0.2 (or newer)

Sodium is a "new, easy-to-use software library for encryption, decryption, signatures, password hashing and more".  ZeroMQ uses sodium for the basis of the CurveZMQ security protocol.

```
git clone git@github.com:jedisct1/libsodium.git
cd libsodium
./autogen.sh; ./configure; make; make check
sudo make install
sudo ldconfig
```

### [ZeroMQ](http://zeromq.org/) 
Version: commit 6b4d9bca0c31fc8131749396fd996d17761c999f or newer

ZeroMQ is an embeddable [ZMTP](http://rfc.zeromq.org/spec:23) protocol library.

```
git clone git@github.com:zeromq/libzmq.git
cd libzmq
./autogen.sh; ./configure --with-libsodium; make; make check
sudo make install
sudo ldconfig
```

### [CZMQ](http://czmq.zeromq.org/)
Version: commit 7997d86bcac7a916535338e71f2d826a9913df28 or newer

CZMQ is a high-level C binding for ZeroMQ.  It provides an API for various services on top of ZeroMQ such as authentication, actors, service discovery, etc.

```
git clone git@github.com:zeromq/czmq.git
cd czmq
./autogen.sh; ./configure; make; make check
sudo make install
sudo ldconfig
```

### [GoCZMQ](http://https://github.com/zeromq/goczmq)
Version: commit 6b4d9bca0c31fc8131749396fd996d17761c999f or newer

GoCZMQ is a Go interface to the CZMQ API.

```
mkdir -p  $GOPATH/go/src/github.com/zeromq
cd $GOPATH/go/src/github.com/zeromq
git clone git@github.com:zeromq/goczmq.git
cd goczmq
go test
go build; go install
```


### [Rsyslog](http://www.rsyslog.com/)
Version: 8.9.0 or newer

Rsyslog is the "rocket fast system for log processing".

Build dependencies:
* libsodium
* libzmq
* czmq
* libjson-c
* libestr
* liblognorm
* liblogging

You will need to use the "--enable-omczmq" configure flag to build zeromq + curve support.

## Generating Certificates
logtalez uses CURVE security certificates generated by the [zcert](http://api.zeromq.org/czmq3-0:zcert) API.  They are stored in [ZPL](http://rfc.zeromq.org/spec:4) format.  Logtalez includes a simple cert generation tool (curvecertgen) for convenience.

To generate a public / private key pair:

```
$ ./curvecertgen bogus_cert
Name: Brian
Email: bogus@whatever.com
Organization: Bogus Org
Version: 1
```

The above would generate a bogus_cert and bogus_cert_secret file.

## Configuring Your Rsyslog Server

The following rsyslog configuration snippet consists of:
* A template that dynamically sets a "topic" on a message consisting of hostname.syslogtag + an "@cee" cookie and JSON message payload
* A rule snippet that attempts to parse a syslog message as JSON, then outputs it over a zeromq publish socket using the template

```
module(load="mmjsonparse")
module(load="omczmq")

template(name="pubsub_host_tag" type="list") {
  property(name="hostname")
  constant(value=".")
  property(name="syslogtag" position.from="1" position.to="32")
  constant(value="@cee:")
  constant(value="{")
  constant(value="\"@timestamp\":\"")
  property(name="timereported" dateFormat="rfc3339" format="json")
  constant(value="\",\"host\":\"")
  property(name="hostname")
  constant(value="\",\"severity\":\"")
  property(name="syslogseverity-text")
  constant(value="\",\"facility\":\"")
  property(name="syslogfacility-text")
  constant(value="\",\"syslogtag\":\"")
  property(name="syslogtag" format="json")
  constant(value="\",")
  property(name="$!all-json" position.from="2")
} 

ruleset(name="zmq_pubsub_out") {
  action(
    name="zmq_pubsub"
    template="pubsub_host_tag"
    type="omczmq"
    endpoints="tcp://*:24444"
    socktype="PUB"
    authtype="CURVESERVER"
    clientcertpath="/etc/curve.d/"
    servercertpath="/etc/curve.d/my_server_cert"
  )
}

action(type="mmjsonprase")
if $parsesuccess == "OK" then {
  call zmq_pubsub_out
} 
```

## Running Logtalez

### Flags
* --endpoints - comma delimited list of zeromq syslog outputs to connect to
* --servercertpath - path to server public cert
* --clientcertpath - path to client public cert
* --hosts - comma delimited list of hosts to get realtime logs from
* --programs - comma delimited list of programs to get realtime logs from

### Example
```
./logtalez --endpoints=tcp://server1:24444,tcp://server2:24444 --servercertpath=/path/to/server_public_cert --clientcertpath=/path/to/client_public_cert --hosts=somehost,anotherhost --programs=nginx,apache
```

### Todo
* Support for custom topic formats and custom json delimiters
* Dockerized build for ease of distribution
* Dockerized rsyslog "appliance" with support baked in

## Tools That Work Well with Logtalez
* [jq](https://stedolan.github.io/jq/) JSON processor
* [humanlog](https://github.com/aybabtme/humanlog) "Logs for humans to read."
* Anything that can read stdout!

## API Documentation

# logtalez
--
    import "github.com/digitalocean/logtalez"


## Usage

#### func  MakeEndpointList

```go
func MakeEndpointList(endpoints string) []string
```
MakeEndpointList is a convenience function that, given a list of comma delimited
zeromq endpoints, returns a slice containing the endpoints.

#### func  MakeTopicList

```go
func MakeTopicList(hosts, programs string) []string
```
MakeTopicList is a convenience function that, given a string of comma delimited
hosts and a string of comma delimited program name tags, generates a slice of
subscription topics.

#### type LogTalez

```go
type LogTalez struct {
	TailChan <-chan [][]byte
}
```

LogTalez holds the context for a running LogTalez instance

#### func  New

```go
func New(endpoints, topics []string, serverCertPath, clientCertPath string) (*LogTalez, error)
```
New returns a new running LogTalez instance given a slice of endpoints, a slice
of topics, and the path to a CURVE server public cert and CURVE server client
cert. The TailChan member is a channel that returns [][]byte messages from
ZeroMQ.

#### func (*LogTalez) Destroy

```go
func (lt *LogTalez) Destroy()
```
Destroy gracefully shuts down a running LogTalez instance
